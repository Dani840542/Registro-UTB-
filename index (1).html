<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registro de Asistencia UTB</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  h1, h2 {
    text-align: center;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
  }
  input, button {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    font-size: 1em;
  }
  button {
    cursor: pointer;
  }
  #estado {
    margin-top: 10px;
    font-weight: bold;
    text-align: center;
  }
  #registros {
    margin-top: 15px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
  }
  .registro-item {
    border-bottom: 1px solid #ddd;
    padding: 8px 0;
  }
  .registro-item:last-child {
    border-bottom: none;
  }
  @media (max-width: 480px) {
    body {
      margin: 10px;
    }
  }
</style>
</head>
<body>

<h1>Registro de Asistencia UTB</h1>

<section>
  <h2>Ingreso Estudiante</h2>
  <p id="ubicacion-status">üì° Esperando ubicaci√≥n...</p>

  <label for="curso">C√≥digo de Curso:</label>
  <input type="text" id="curso" placeholder="Ej: MAT101" disabled />

  <label for="cedula">√öltimos 4 d√≠gitos de la c√©dula:</label>
  <input type="text" id="cedula" maxlength="4" placeholder="Ej: 1234" disabled />

  <button id="botonRegistrar" disabled>Registrar Entrada</button>

  <p id="estado"></p>
</section>

<section>
  <h2>Consulta de Registros (Solo Lectura)</h2>
  <button id="btnMostrarRegistros">Ver Registros</button>
  <button id="btnExportarExcel">Exportar a Excel</button>
  <div id="registros"></div>
</section>

<script>
  const utbLat = -1.800857;
  const utbLon = -79.534293;
  const radioPermitidoKm = 0.2; // 200 metros

  let ubicacionDetectada = null;

  const estadoEl = document.getElementById('estado');
  const ubicacionStatusEl = document.getElementById('ubicacion-status');
  const cursoInput = document.getElementById('curso');
  const cedulaInput = document.getElementById('cedula');
  const botonRegistrar = document.getElementById('botonRegistrar');
  const registrosDiv = document.getElementById('registros');
  const btnMostrarRegistros = document.getElementById('btnMostrarRegistros');
  const btnExportarExcel = document.getElementById('btnExportarExcel');

  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function solicitarUbicacion() {
    if (!navigator.geolocation) {
      ubicacionStatusEl.textContent = '‚ùå Tu navegador no soporta geolocalizaci√≥n.';
      ubicacionStatusEl.style.color = 'red';
      return;
    }

    ubicacionStatusEl.textContent = 'üì° Solicitando ubicaci√≥n...';

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const distancia = calcularDistancia(lat, lon, utbLat, utbLon);

        if (distancia <= radioPermitidoKm) {
          ubicacionDetectada = { lat, lon };
          ubicacionStatusEl.textContent = '‚úÖ Ubicaci√≥n validada: est√°s dentro del campus UTB.';
          ubicacionStatusEl.style.color = 'green';
          cursoInput.disabled = false;
          cedulaInput.disabled = false;
          botonRegistrar.disabled = false;
        } else {
          ubicacionStatusEl.textContent = '‚ùå Est√°s fuera del campus UTB. No puedes registrar.';
          ubicacionStatusEl.style.color = 'red';
          cursoInput.disabled = true;
          cedulaInput.disabled = true;
          botonRegistrar.disabled = true;
        }
      },
      (error) => {
        ubicacionStatusEl.textContent = '‚ùå No se pudo obtener la ubicaci√≥n. Activa el GPS y recarga.';
        ubicacionStatusEl.style.color = 'red';
        cursoInput.disabled = true;
        cedulaInput.disabled = true;
        botonRegistrar.disabled = true;
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  }

  function validarDatos(curso, cedula) {
    return curso.trim() !== '' && /^\d{4}$/.test(cedula);
  }

  function registrar() {
    estadoEl.textContent = '';
    if (!ubicacionDetectada) {
      estadoEl.textContent = '‚ùå No hay ubicaci√≥n v√°lida.';
      estadoEl.style.color = 'red';
      return;
    }

    const curso = cursoInput.value.trim();
    const cedula = cedulaInput.value.trim();

    if (!validarDatos(curso, cedula)) {
      estadoEl.textContent = '‚ùå Datos inv√°lidos.';
      estadoEl.style.color = 'red';
      return;
    }

    const registro = {
      curso,
      cedula,
      fecha: new Date().toLocaleString(),
      lat: ubicacionDetectada.lat,
      lon: ubicacionDetectada.lon,
    };

    const registros = JSON.parse(localStorage.getItem('registros_utb') || '[]');
    registros.push(registro);
    localStorage.setItem('registros_utb', JSON.stringify(registros));

    estadoEl.textContent = '‚úÖ Registro guardado con √©xito.';
    estadoEl.style.color = 'green';
    cursoInput.value = '';
    cedulaInput.value = '';
  }

  function mostrarRegistros() {
    registrosDiv.innerHTML = '';
    const registros = JSON.parse(localStorage.getItem('registros_utb') || '[]');

    if (registros.length === 0) {
      registrosDiv.textContent = 'No hay registros para mostrar.';
      return;
    }

    registros.forEach((reg, i) => {
      const div = document.createElement('div');
      div.classList.add('registro-item');
      div.innerHTML = `<strong>#${i+1}</strong> - Curso: ${reg.curso} - C√©dula: ${reg.cedula} - Fecha: ${reg.fecha} - Ubicaci√≥n: ${reg.lat.toFixed(5)}, ${reg.lon.toFixed(5)}`;
      registrosDiv.appendChild(div);
    });
  }

  function exportarExcel() {
    const registros = JSON.parse(localStorage.getItem('registros_utb') || '[]');
    if (registros.length === 0) {
      alert('No hay registros para exportar.');
      return;
    }

    let csv = 'Curso,C√©dula,Fecha,Latitud,Longitud\n';
    registros.forEach(reg => {
      csv += `${reg.curso},${reg.cedula},${reg.fecha},${reg.lat},${reg.lon}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'registros_utb.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  botonRegistrar.addEventListener('click', registrar);
  btnMostrarRegistros.addEventListener('click', mostrarRegistros);
  btnExportarExcel.addEventListener('click', exportarExcel);
  window.onload = solicitarUbicacion;
</script>

</body>
</html>